
IDENTIFICATION DIVISION.
PROGRAM-ID. TRAP-TILES.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT INPUT-FILE ASSIGN TO "input.txt"
        ORGANIZATION IS LINE SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD INPUT-FILE.
01 INPUT-RECORD PIC X(200).

WORKING-STORAGE SECTION.
01 WS-ROW-LENGTH           PIC 9(03) VALUE ZEROS.
01 WS-CURRENT-ROW          PIC X(200).
01 WS-NEXT-ROW             PIC X(200).
01 WS-SAFE-COUNT           PIC 9(10) VALUE ZEROS.
01 WS-TOTAL-ROWS           PIC 9(10) VALUE 400000.
01 WS-ROW-IDX              PIC 9(10).
01 WS-CHAR-IDX             PIC 9(03).
01 WS-LEFT-CHAR            PIC X(01).
01 WS-RIGHT-CHAR           PIC X(01).
01 WS-EOF-FLAG             PIC X(01) VALUE 'N'.
    88 EOF                         VALUE 'Y'.

PROCEDURE DIVISION.
MAIN-LOGIC.
    PERFORM READ-FIRST-ROW
    PERFORM COUNT-SAFE-TILES
    DISPLAY WS-SAFE-COUNT
    STOP RUN.

READ-FIRST-ROW.
    OPEN INPUT INPUT-FILE
    READ INPUT-FILE
        AT END SET EOF TO TRUE
    END-READ
    IF NOT EOF
        MOVE FUNCTION TRIM(INPUT-RECORD) TO WS-CURRENT-ROW
        COMPUTE WS-ROW-LENGTH = FUNCTION LENGTH(FUNCTION TRIM(INPUT-RECORD))
    ELSE
        DISPLAY "Error: input.txt is empty or not found."
        STOP RUN
    END-IF
    CLOSE INPUT-FILE.

COUNT-SAFE-TILES.
    PERFORM VARYING WS-CHAR-IDX FROM 1 BY 1 UNTIL WS-CHAR-IDX > WS-ROW-LENGTH
        IF WS-CURRENT-ROW(WS-CHAR-IDX:1) = '.'
            ADD 1 TO WS-SAFE-COUNT
        END-IF
    END-PERFORM

    PERFORM VARYING WS-ROW-IDX FROM 2 BY 1 UNTIL WS-ROW-IDX > WS-TOTAL-ROWS
        MOVE SPACES TO WS-NEXT-ROW
        PERFORM VARYING WS-CHAR-IDX FROM 1 BY 1 UNTIL WS-CHAR-IDX > WS-ROW-LENGTH
            PERFORM DETERMINE-TILE-TYPE
            IF WS-NEXT-ROW(WS-CHAR-IDX:1) = '.'
                ADD 1 TO WS-SAFE-COUNT
            END-IF
        END-PERFORM
        MOVE WS-NEXT-ROW TO WS-CURRENT-ROW
    END-PERFORM.

DETERMINE-TILE-TYPE.
    MOVE '.' TO WS-LEFT-CHAR
    MOVE '.' TO WS-RIGHT-CHAR

    IF WS-CHAR-IDX > 1
        MOVE WS-CURRENT-ROW(WS-CHAR-IDX - 1:1) TO WS-LEFT-CHAR
    END-IF

    IF WS-CHAR-IDX < WS-ROW-LENGTH
        MOVE WS-CURRENT-ROW(WS-CHAR-IDX + 1:1) TO WS-RIGHT-CHAR
    END-IF

    IF WS-LEFT-CHAR NOT EQUAL WS-RIGHT-CHAR
        MOVE '^' TO WS-NEXT-ROW(WS-CHAR-IDX:1)
    ELSE
        MOVE '.' TO WS-NEXT-ROW(WS-CHAR-IDX:1)
    END-IF.
